"use strict";(self.webpackChunkai_assistant=self.webpackChunkai_assistant||[]).push([[428],{428(e,t,r){r.r(t),r.d(t,{activate:()=>l,deactivate:()=>s});var o=r(43),n=r.n(o),a=r(919);const i=()=>{const e=(0,a.useTheme)(),t=(0,o.useMemo)(()=>{return{container:{display:"flex",flexDirection:"column",height:"100%",fontFamily:(t=e).fontFamily,fontSize:t.fontSize,backgroundColor:t.colorBgLayout,color:t.colorText},header:{padding:`${t.paddingSM}px ${t.padding}px`,borderBottom:`1px solid ${t.colorBorderSecondary}`,backgroundColor:t.colorBgContainer,fontWeight:t.fontWeightStrong,fontSize:t.fontSizeLG,display:"flex",alignItems:"center",gap:t.sizeXS},headerIcon:{fontSize:t.fontSizeLG},betaBadge:{fontSize:t.fontSizeSM-2,color:t.colorTextTertiary,marginLeft:"auto"},messagesContainer:{flex:1,overflowY:"auto",padding:`${t.paddingSM}px ${t.padding}px`},messageBubble:e=>({marginBottom:t.marginSM,padding:`${t.paddingXS+2}px ${t.paddingSM+2}px`,borderRadius:t.borderRadius,backgroundColor:e?t.colorPrimary:t.colorBgContainer,color:e?"#fff":t.colorText,border:e?"none":`1px solid ${t.colorBorderSecondary}`,maxWidth:"100%",lineHeight:t.lineHeight,whiteSpace:"pre-wrap",wordBreak:"break-word"}),stepsContainer:{marginTop:t.marginXS,padding:`${t.paddingXS}px ${t.paddingXS+2}px`,backgroundColor:t.colorFillQuaternary,borderRadius:t.borderRadiusSM,fontSize:t.fontSizeSM-2,color:t.colorTextTertiary,border:`1px solid ${t.colorBorderSecondary}`},stepItem:{padding:"2px 0",display:"flex",gap:6,alignItems:"flex-start"},stepIcon:{color:t.colorSuccess,flexShrink:0},stepArgs:{color:t.colorTextTertiary},inputContainer:{padding:`${t.paddingSM}px ${t.padding}px`,borderTop:`1px solid ${t.colorBorderSecondary}`,backgroundColor:t.colorBgContainer},textArea:{width:"100%",border:`1px solid ${t.colorBorder}`,borderRadius:t.borderRadius,padding:`${t.paddingXS}px ${t.paddingSM}px`,fontSize:t.fontSize,resize:"none",outline:"none",fontFamily:"inherit",lineHeight:t.lineHeight,minHeight:60,maxHeight:120,backgroundColor:t.colorBgContainer,color:t.colorText},buttonRow:{display:"flex",justifyContent:"flex-end",marginTop:t.marginXS,gap:t.sizeXS},sendButton:e=>({padding:`${t.paddingXS-2}px ${t.padding}px`,backgroundColor:e?t.colorFillSecondary:t.colorPrimary,color:e?t.colorTextTertiary:"#fff",border:"none",borderRadius:t.borderRadiusSM,cursor:e?"not-allowed":"pointer",fontSize:t.fontSize,fontWeight:t.fontWeightStrong}),clearButton:{padding:`${t.paddingXS-2}px ${t.paddingSM}px`,backgroundColor:"transparent",color:t.colorTextSecondary,border:`1px solid ${t.colorBorder}`,borderRadius:t.borderRadiusSM,cursor:"pointer",fontSize:t.fontSizeSM},loadingDots:{display:"inline-flex",gap:4,padding:`${t.paddingXS+2}px ${t.paddingSM+2}px`,backgroundColor:t.colorBgContainer,border:`1px solid ${t.colorBorderSecondary}`,borderRadius:t.borderRadius,marginBottom:t.marginSM,color:t.colorTextSecondary},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:t.colorTextTertiary,textAlign:"center",padding:2*t.paddingLG,gap:t.marginSM},emptyIcon:{fontSize:40,opacity:.5},emptySubtext:{fontSize:t.fontSizeSM,color:t.colorTextPlaceholder},errorBubble:{marginBottom:t.marginSM,padding:`${t.paddingXS+2}px ${t.paddingSM+2}px`,borderRadius:t.borderRadius,backgroundColor:t.colorErrorBg,color:t.colorError,border:`1px solid ${t.colorErrorBorder}`,fontSize:t.fontSizeSM},runQueryButton:{display:"inline-flex",alignItems:"center",gap:6,marginTop:t.marginXS,marginBottom:t.marginSM,padding:`${t.paddingXS-2}px ${t.paddingSM+2}px`,backgroundColor:t.colorSuccess,color:"#fff",border:"none",borderRadius:t.borderRadiusSM,cursor:"pointer",fontSize:t.fontSizeSM,fontWeight:t.fontWeightStrong},stepSpinner:{display:"inline-block",width:10,height:10,border:`2px solid ${t.colorTextQuaternary}`,borderTopColor:t.colorPrimary,borderRadius:"50%",animation:"vambery-spin 0.8s linear infinite",flexShrink:0},streamingLabel:{fontWeight:600,marginBottom:4,display:"flex",alignItems:"center",gap:6}};var t},[e]),[r,i]=(0,o.useState)([]),[l,s]=(0,o.useState)(""),[d,c]=(0,o.useState)(!1),[p,u]=(0,o.useState)([]),g=(0,o.useRef)(null),m=(0,o.useRef)(null);(0,o.useEffect)(()=>{var e;null===(e=g.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[r,d,p]),(0,o.useEffect)(()=>{const e="vambery-spin-keyframes";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent="@keyframes vambery-spin { to { transform: rotate(360deg); } }",document.head.appendChild(t)}},[]);const y=(0,o.useCallback)(async()=>{const e=a.sqlLab.getCurrentTab();let t="";if(e)try{t=(await e.getEditor()).getValue()||""}catch(e){console.warn("[Vambery AI] Could not get editor content:",e)}return{database_id:null==e?void 0:e.databaseId,database_name:void 0,schema:(null==e?void 0:e.schema)||null,catalog:(null==e?void 0:e.catalog)||null,current_sql:t}},[]),b=(0,o.useCallback)(async e=>{if("set_editor_sql"===e.type&&e.sql){const t=a.sqlLab.getCurrentTab();if(t)try{if((await t.getEditor()).setValue(e.sql),console.log("[Vambery AI] Set editor SQL:",e.sql.slice(0,80)),e.sql.trim().toUpperCase().startsWith("SELECT")||e.sql.trim().toUpperCase().startsWith("WITH")){await new Promise(e=>setTimeout(e,150));try{await a.sqlLab.executeQuery(),console.log("[Vambery AI] Auto-executed query")}catch(e){console.error("[Vambery AI] Failed to auto-execute query:",e)}return!0}}catch(e){console.error("[Vambery AI] Failed to set editor SQL:",e)}}return!1},[]),f=(0,o.useCallback)(async()=>{try{await a.sqlLab.executeQuery(),console.log("[Vambery AI] Query executed")}catch(e){console.error("[Vambery AI] Failed to execute query:",e)}},[]),S=(0,o.useCallback)(async()=>{const e=l.trim();if(!e||d)return;const t={role:"user",content:e,timestamp:Date.now()};i(e=>[...e,t]),s(""),c(!0),u([]);try{const t=await y();if(!t.database_id)return i(e=>[...e,{role:"assistant",content:"Please select a database in the left sidebar first, so I know which database to work with.",timestamp:Date.now(),error:!0}]),void c(!1);const o=[...r.map(e=>({role:e.role,content:e.content})),{role:"user",content:e}],n=[],l=[];let s="",d=!1,p=!1;await async function(e,t,r){var o;const n=await a.authentication.getCSRFToken(),i=await fetch("/api/v1/ai_assistant/chat/stream",{method:"POST",headers:{"Content-Type":"application/json",...n?{"X-CSRFToken":n}:{}},credentials:"same-origin",body:JSON.stringify({messages:e,context:t})});if(!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.error||`HTTP ${i.status}: ${i.statusText}`)}const l=null===(o=i.body)||void 0===o?void 0:o.getReader();if(!l)throw new Error("ReadableStream not supported");const s=new TextDecoder;let d="";for(;;){const{done:e,value:t}=await l.read();if(e)break;d+=s.decode(t,{stream:!0});const o=d.split("\n\n");d=o.pop()||"";for(const e of o){if(!e.trim())continue;let t="",o="";for(const r of e.split("\n"))r.startsWith("event: ")?t=r.slice(7).trim():r.startsWith("data: ")&&(o=r.slice(6));if(t&&o)try{r({event:t,data:JSON.parse(o)})}catch(e){console.warn("[Vambery AI] Failed to parse SSE event:",e,o)}}}}(o,t,async e=>{if("step"===e.event){const t=e.data;n.push(t),u([...n])}else if("action"===e.event){const t=e.data;l.push(t),await b(t)&&(p=!0)}else"response"===e.event?s=e.data.response||"I couldn't generate a response.":"error"===e.event&&(s=`Error: ${e.data.error||"Something went wrong"}`,d=!0)});const g={role:"assistant",content:s||"I couldn't generate a response.",timestamp:Date.now(),steps:n,actions:l,error:d,hasRunnable:p};i(e=>[...e,g])}catch(e){console.error("[Vambery AI] Chat error:",e),i(t=>[...t,{role:"assistant",content:`Error: ${e.message||"Something went wrong"}`,timestamp:Date.now(),error:!0}])}finally{c(!1),u([])}},[l,d,r,y,b]),h=(0,o.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),S())},[S]),x=(0,o.useCallback)(()=>{i([]),s("")},[]);return n().createElement("div",{style:t.container},n().createElement("div",{style:t.header},n().createElement("span",{style:t.headerIcon},"ðŸ¤–"),n().createElement("span",null,"Vambery AI Agent"),n().createElement("span",{style:t.betaBadge},"BETA")),n().createElement("div",{style:t.messagesContainer},0===r.length&&!d&&n().createElement("div",{style:t.emptyState},n().createElement("div",{style:t.emptyIcon},"ðŸ’¬"),n().createElement("div",null,n().createElement("strong",null,"Ask me anything about your data")),n().createElement("div",{style:t.emptySubtext},"I can explore schemas, write SQL queries, and help you analyse your data. Select a database and schema first, then describe what you need.")),r.map((e,r)=>n().createElement("div",{key:r},"user"===e.role&&n().createElement("div",{style:t.messageBubble(!0)},e.content),"assistant"===e.role&&n().createElement(n().Fragment,null,e.steps&&e.steps.length>0&&n().createElement("div",{style:t.stepsContainer},n().createElement("div",{style:{fontWeight:600,marginBottom:4}},"Agent steps:"),e.steps.map((e,r)=>n().createElement("div",{key:r,style:t.stepItem},n().createElement("span",{style:t.stepIcon},"âœ“"),n().createElement("span",null,n().createElement("strong",null,e.tool),e.args&&Object.keys(e.args).length>0&&n().createElement("span",{style:t.stepArgs},"(",Object.values(e.args).join(", "),")")," â€” ",e.result_summary)))),e.error?n().createElement("div",{style:t.errorBubble},e.content):n().createElement("div",{style:t.messageBubble(!1)},e.content),e.hasRunnable&&n().createElement("button",{style:t.runQueryButton,onClick:f,type:"button"},"â–¶ Re-run query")))),d&&n().createElement("div",null,n().createElement("div",{style:t.stepsContainer},n().createElement("div",{style:t.streamingLabel},n().createElement("span",{style:t.stepSpinner}),n().createElement("span",null,"Agent working...")),p.map((e,r)=>n().createElement("div",{key:r,style:t.stepItem},n().createElement("span",{style:t.stepIcon},"âœ“"),n().createElement("span",null,n().createElement("strong",null,e.tool),e.args&&Object.keys(e.args).length>0&&n().createElement("span",{style:t.stepArgs},"(",Object.values(e.args).join(", "),")")," â€” ",e.result_summary))),0===p.length&&n().createElement("div",{style:{color:t.stepsContainer.color,padding:"2px 0"}},"Connecting to AI..."))),n().createElement("div",{ref:g})),n().createElement("div",{style:t.inputContainer},n().createElement("textarea",{ref:m,style:t.textArea,value:l,onChange:e=>s(e.target.value),onKeyDown:h,placeholder:"Ask about your data... (Enter to send, Shift+Enter for newline)",disabled:d,rows:3}),n().createElement("div",{style:t.buttonRow},r.length>0&&n().createElement("button",{style:t.clearButton,onClick:x,type:"button"},"Clear"),n().createElement("button",{style:t.sendButton(d||!l.trim()),onClick:S,disabled:d||!l.trim(),type:"button"},d?"Thinking...":"Send"))))},l=e=>{e.disposables.push(a.core.registerViewProvider("ai_assistant.chatPanel",()=>n().createElement(i,null))),console.log("[Vambery AI Agent] Extension activated")},s=()=>{console.log("[Vambery AI Agent] Extension deactivated")}}}]);